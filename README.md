# Go Generate Manager

一个高效的 Go 代码生成工具管理器。

## 功能特点

- 并发执行代码生成命令
- 智能缓存，避免重复生成
- 支持多种代码生成工具 (mockgen, protoc 等)
- 自动检测文件变更
- 可配置的并发数量

## 安装

```bash
go install github.com/llamazing-cn/go-generate-manager/cmd/gogen@latest
```

## 使用方法

基本用法：
```bash
# 在当前目录执行 mockgen
gogen -c mockgen

# 指定目录
gogen -d ./pkg -c mockgen

# 指定输出目录
gogen -d ./pkg -c mockgen -o ./gen

# 自定义 worker 数量
gogen -c mockgen -w 4
```

完整参数说明：
```
Usage: gogen [options]

Options:
  -d, --dir     <path>     目标目录 (默认: 当前目录)
  -c, --cmd     <command>  生成命令 (必需)
  -o, --output  <path>     输出目录 (默认: 同源目录)
  -w, --workers <number>   worker数量 (默认: min(CPU数量*2, 8))
  -h, --help              显示帮助信息
```

## 性能基准测试

我们对不同数量的 worker 进行了基准测试，测试环境和结果如下：

### 测试环境
- **OS**: Darwin (macOS)
- **Arch**: arm64
- **CPU**: Apple M3
- **测试数据**: 20个包，每个包5个接口，每个接口约10个方法
- **总计**: 100个文件，约1000个需要生成的方法

### 测试结果

#### 执行时间
| Workers | 时间 (s) | 性能提升 |
| ------- | -------- | -------- |
| 1       | 4.53     | 基准线   |
| 2       | 2.85     | +37%     |
| 4       | 2.11     | +53%     |
| 8       | 2.05     | +54%     |
| 16      | 2.11     | +53%     |
| 32      | 2.15     | +52%     |
| 64      | 2.18     | +51%     |
| 128     | 2.21     | +51%     |

#### 内存使用
| Workers | 内存 (MB) | 分配次数 |
| ------- | --------- | -------- |
| 1       | 3.2       | 19,597   |
| 2       | 4.9       | 23,879   |
| 4       | 4.9       | 23,835   |
| 8       | 4.9       | 23,853   |
| 16      | 4.9       | 23,766   |
| 32      | 5.0       | 23,866   |
| 64      | 5.1       | 23,909   |
| 128     | 5.1       | 23,881   |

### 分析结论

1. **最佳 Worker 数量**: 8
   - 提供最快的执行时间 (2.05s)
   - 相比单 worker 提升了54%的性能
   - 内存使用保持在合理水平 (4.9MB)

2. **性能拐点**
   - 8个 workers 后性能开始下降
   - 16个以上的 workers 不会带来额外性能提升
   - 过多的 workers 反而会增加系统开销

3. **内存使用情况**
   - 2个 workers 时内存使用就达到稳定水平
   - 32个以上 workers 会导致内存使用缓慢增加
   - 内存分配次数在增加 workers 后保持稳定

4. **建议配置**
   - 小型项目 (<10 文件): 使用 4 个 workers
   - 中型项目 (10-50 文件): 使用 8 个 workers
   - 大型项目 (>50 文件): 仍建议使用 8 个 workers
   - 默认配置: `min(runtime.NumCPU() * 2, 8)`

### 测试代码

完整的基准测试代码位于 `tests/bench_test.go`。测试用例包括：
- 20个不同的包
- 每个包5个不同的接口文件
- 每个接口约10个方法
- 使用真实的 mockgen 进行代码生成

运行基准测试：
```bash
go test -bench=. -benchmem ./tests
```

### FAQ

1. 为什么需要使用 `-c` 参数指定生成命令？
> * 通过指定命令，可以更精确地控制生成过程，避免不必要的文件生成。

2. 为什么使用 xxHash 而不是 MD5/SHA1？
> * xxHash 是目前最快的非加密哈希算法之一，性能是 MD5 的30倍左右
> * 我们只需要检测文件内容变化，不需要加密特性
> * xxHash 在现代 CPU 上可以达到内存带宽的极限
> * 使用对象池优化，进一步提升性能

3. 缓存文件保存在哪里？
> * 默认保存在输出目录下，文件名为 `{command}.sum`
> * 例如使用 mockgen 时，缓存文件为 `mockgen.sum`
> * 缓存文件使用文本格式，方便版本控制

4. 如何处理生成失败的情况？
> * 单个文件生成失败不会影响其他文件
> * 错误信息会包含具体的文件路径和命令
> * 可以通过日志查看详细的错误原因
> * 建议将失败的文件添加到 .gitignore

5. 支持哪些代码生成工具？
> * 任何使用 `//go:generate` 注释的工具
> * 自定义的代码生成命令



